<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¦‘ CCFOLIA LogTool</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-dark: #1e1f22;
    --card-bg: #2b2d31;
    --accent: #C5373C;
    --line-pink: #F50057; 
    --text-main: #dbdee1;
    --text-sub: #b5bac1;
    --hp-red: #ff5252;
    --san-blue: #00a0e9;
    --crit-color: #00e676;
  }

  body { font-family: 'Noto Sans JP', sans-serif; line-height: 1.6; max-width: 1200px; margin: 20px auto; padding: 0 15px; background-color: var(--bg-dark); color: var(--text-main); }
  .card { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); text-align: center; margin-bottom: 20px; }
  h2 { color: #fff; font-weight: 700; letter-spacing: 0.1em; margin-bottom: 5px; }
  .privacy-note { font-size: 0.75em; color: var(--text-sub); margin-bottom: 25px; }
  
  .guide-container { text-align: left; background: #313338; border-radius: 8px; margin-bottom: 25px; overflow: hidden; }
  .guide-header { padding: 10px 20px; background: #383a40; cursor: pointer; font-size: 0.9em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  .guide-content { padding: 20px; font-size: 0.85em; display: none; }
  
  .file-input-area { border: 2px dashed #4f545c; padding: 30px 20px; border-radius: 8px; background: #313338; cursor: pointer; margin-bottom: 20px; position: relative; }
  input[type="file"] { display: none; }
  .file-label { color: var(--accent); text-decoration: underline; font-weight: bold; }
  
  .file-info-box { font-size: 0.85em; color: var(--accent); margin: 20px auto 0; background: rgba(197, 55, 60, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent); max-width: 500px; text-align: left; display: none; }
  .file-info-box .file-name { font-weight: bold; display: block; margin-bottom: 4px; }
  .file-info-box .next-guide { font-size: 0.85em; color: var(--text-sub); display: block; margin-top: 4px; }

  .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  .btn { display: none; padding: 10px 25px; font-size: 14px; cursor: pointer; background-color: var(--accent); color: white; border: none; border-radius: 25px; font-weight: bold; transition: 0.2s; }

  #statsArea { display: none; flex-direction: column; gap: 20px; margin-top: 20px; }
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
  .stats-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); overflow-x: auto; }
  .stats-card h3 { border-bottom: 2px solid var(--line-pink); padding-bottom: 10px; margin-bottom: 20px; color: #fff; font-size: 1.1em; text-align: left; }
  
  table { width: 100%; border-collapse: collapse; font-size: 0.9em; min-width: 380px; }
  th { padding: 10px; text-align: left; color: var(--text-sub); font-size: 0.8em; border-bottom: 1px solid rgba(255,255,255,0.1); }
  td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }

  .bar-container { background: #1e1f22; height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden; width: 100%; }
  .bar-fill { height: 100%; transition: width 0.5s ease-out; }

  @media screen and (max-width: 600px) {
    .stats-card { padding: 15px; }
    table { font-size: 0.85em; min-width: 300px; }
    td, th { padding: 10px 5px; }
  }

  #excludeSection { background: #313338; padding: 20px; border-radius: 8px; margin-top: 30px; text-align: left; display: none; }
  .exclude-title { font-size: 0.85em; font-weight: bold; margin-bottom: 12px; color: var(--accent); }
  .exclude-list { display: flex; flex-wrap: wrap; gap: 10px; }
  .exclude-item { background: #1e1f22; padding: 8px 16px; border-radius: 20px; font-size: 0.8em; cursor: pointer; transition: 0.2s; color: #b5bac1; border: 1px solid transparent; }
  .exclude-item.is-active { background: #4f545c; color: #fff; border-color: #6e7278; }
  .exclude-item input { display: none; }

  .c-text { color: var(--crit-color); font-weight: bold; }
  .f-text { color: var(--hp-red); font-weight: bold; }
  .rank-name { font-weight: 500; color: #fff; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
  .skill-tag { background: #383a40; color: var(--accent); padding: 2px 8px; border-radius: 4px; font-weight: bold; }
</style>
</head>
<body>
<div class="card">
  <h2>LogTool for CCFOLIA</h2>
  <p class="privacy-note">â€»ãƒ­ã‚°ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãšã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
  
  <div class="guide-container">
    <div class="guide-header" onclick="toggleGuide()"><span>âœ¦ ã¤ã‹ã„ã‹ãŸ</span><span id="guideArrow">â–¼</span></div>
    <div class="guide-content" id="guideContent">
      <ul style="margin:0; padding-left:20px; font-size:0.85em;">
        <li><b>è§£æã—ã¦çµ±è¨ˆã‚’è¡¨ç¤º</b>ï¼šãƒ€ã‚¤ã‚¹çµ±è¨ˆã€HP/SANå¢—æ¸›ã€ãƒãƒ£ãƒƒãƒˆæ•°ã€æŠ€èƒ½ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</li>
        <li><b>æƒé™¤æ¸ˆã¿ãƒ­ã‚°ã‚’ä¿å­˜</b>ï¼šã€Œå‰Šé™¤æ¸ˆã€ã¨ç©ºç™½ç™ºè¨€ã‚’æ¶ˆå»ã—ãŸãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã™ã€‚</li>
        <li><b>ä¼šè©±ãƒ­ã‚°ã‚’ä¿å­˜</b>ï¼šsystemãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€å‰Šé™¤æ¸ˆã€ç©ºç™½ç™ºè¨€ã‚’æ¶ˆã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</li>
      </ul>
    </div>
  </div>
  
  <div class="file-input-area" id="dropZone">
    <label for="logFile" style="cursor:pointer; display:block;">
      <p id="dropText">ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹<br><span class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span></p>
      <input type="file" id="logFile" accept=".html,.txt">
      <div id="fileInfoBox" class="file-info-box"></div>
    </label>
  </div>

  <div class="btn-group">
    <button id="processBtn" class="btn">è§£æã—ã¦çµ±è¨ˆã‚’è¡¨ç¤º</button>
    <button id="downloadBtn" class="btn">æƒé™¤æ¸ˆã¿ãƒ­ã‚°ã‚’ä¿å­˜</button>
    <button id="saveRpHtmlBtn" class="btn">ä¼šè©±ãƒ­ã‚°ã‚’ä¿å­˜</button>
  </div>

  <div id="excludeSection">
    <div class="exclude-title">è¡¨ç¤ºã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é¸æŠï¼š</div>
    <div id="excludeList" class="exclude-list"></div>
  </div>
  <div id="status" style="margin-top:15px; font-size: 0.9em; color: var(--text-sub);"></div>
</div>

<div id="statsArea"></div>

<script>
  function toggleGuide() {
    const content = document.getElementById('guideContent');
    content.style.display = (content.style.display === 'block') ? 'none' : 'block';
    document.getElementById('guideArrow').innerText = (content.style.display === 'block') ? 'â–²' : 'â–¼';
  }

  let originalHtml = "", diceUsers = new Set(), currentFileName = "";
  const tabExcludeRegex = /\[info\]|\[other\]/i;
  const diceStrictRegex = /(\bCC\b|\bCCB\b|\d+d\d+).*ï¼/i;
  const autoExcludeRegex = /KP|GM|ã‚­ãƒ¼ãƒ‘ãƒ¼|â–½|ğŸ¦‘|ğŸœ/i;

  function isPracticallyEmpty(element) {
    if (!element) return true;
    const text = element.textContent || element.innerText || "";
    return text.replace(/[\sã€€\n\r]/g, '').replace(/&nbsp;/g, '').length === 0;
  }

  function resetAll() {
    originalHtml = "";
    diceUsers.clear();
    document.getElementById('statsArea').innerHTML = '';
    document.getElementById('statsArea').style.display = 'none';
    document.getElementById('excludeSection').style.display = 'none';
    document.getElementById('excludeList').innerHTML = '';
    document.getElementById('status').innerText = '';
    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ—¦å…¨éƒ¨éš ã™
    document.querySelectorAll('.btn').forEach(b => b.style.display = 'none');
  }

  function handleFile(file) {
    if (!file) return;
    resetAll(); // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€å‰ã«å…¨éƒ¨æ¶ˆã™
    
    currentFileName = file.name;
    const infoBox = document.getElementById('fileInfoBox');
    infoBox.innerHTML = `<span class="file-name">é¸æŠä¸­: ${file.name}</span><span class="next-guide">åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™</span>`;
    infoBox.style.display = 'block';
    document.getElementById('dropText').style.display = 'none';
    document.getElementById('processBtn').style.display = 'inline-block';

    const reader = new FileReader();
    reader.onload = (ev) => { originalHtml = ev.target.result; };
    reader.readAsText(file, 'UTF-8');
  }

  document.getElementById('logFile').addEventListener('change', (e) => handleFile(e.target.files[0]));
  document.getElementById('dropZone').addEventListener('dragover', (e) => { e.preventDefault(); });
  document.getElementById('dropZone').addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });

  function extractDiceUsers(html) {
    diceUsers.clear();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    doc.querySelectorAll('p').forEach(p => {
      const spans = p.querySelectorAll('span');
      if (spans.length < 2 || tabExcludeRegex.test(spans[0].innerText)) return;
      const text = p.innerText.trim();
      const dM = text.match(/\[.*?\]\s*(.*?)\s*:\s*(.*)/i);
      if (dM && dM[1]) {
        const name = dM[1].trim();
        const msg = dM[2].trim();
        // åå‰ãŒé™¤å¤–å¯¾è±¡ã§ãªãã€ã‹ã¤ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã£ã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ 
        if (!autoExcludeRegex.test(name) && diceStrictRegex.test(msg)) {
          diceUsers.add(name);
        }
      }
    });
  }

  function renderExcludeToggles() {
    const list = document.getElementById('excludeList');
    list.innerHTML = '';
    [...diceUsers].sort().forEach(name => {
      const label = document.createElement('label');
      label.className = 'exclude-item is-active';
      label.innerHTML = `<input type="checkbox" value="${name}" checked> ${name}`;
      label.querySelector('input').addEventListener('change', (e) => {
        label.classList.toggle('is-active', e.target.checked);
        updateStats();
      });
      list.appendChild(label);
    });
  }

  function updateStats() {
    const checkedUsers = Array.from(document.querySelectorAll('#excludeList input:checked')).map(i => i.value);
    const dice = {}, damage = {}, chats = {}, skills = {};
    const doc = new DOMParser().parseFromString(originalHtml, 'text/html');
    
    doc.querySelectorAll('p').forEach(p => {
      const spans = p.querySelectorAll('span');
      if (spans.length < 2 || tabExcludeRegex.test(spans[0].innerText)) return;
      const lastSpan = spans[spans.length - 1];
      const rawText = p.innerText.replace(/\s+/g, ' ');
      const cM = rawText.match(/\[.*?\]\s*(.*?)\s*:\s*(.*)/);

      if (cM && !rawText.startsWith('system :')) {
        const name = cM[1].trim(), msg = cM[2].trim();
        if (msg.includes('å‰Šé™¤æ¸ˆ') || isPracticallyEmpty(lastSpan)) return;
        if (checkedUsers.includes(name)) {
          chats[name] = (chats[name] || 0) + 1;
          const sNames = msg.match(/ã€(.*?)ã€‘/g);
          if (sNames) sNames.forEach(s => {
            const sn = s.replace(/[ã€ã€‘]/g, '').trim();
            if (sn && !sn.match(/ãƒœãƒ¼ãƒŠã‚¹|ãƒšãƒŠãƒ«ãƒ†ã‚£/)) {
              if (!skills[sn]) skills[sn] = { total: 0, users: {} };
              skills[sn].total++; skills[sn].users[name] = (skills[sn].users[name] || 0) + 1;
            }
          });
          const dR = msg.match(/(?:\b(CC|CCB)\b.*)?ï¼\s*(\d+)/i);
          if (dR) {
            if (!dice[name]) dice[name] = { name, total: 0, crit: 0, fum: 0, suc: 0, sumValues: 0 };
            dice[name].total++; dice[name].sumValues += parseInt(dR[2]);
            if (msg.match(/ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«|æ±ºå®šçš„æˆåŠŸ/)) { dice[name].crit++; dice[name].suc++; }
            else if (msg.match(/ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«|è‡´å‘½çš„å¤±æ•—/)) { dice[name].fum++; }
            else if (msg.match(/æˆåŠŸ|ã‚¹ãƒšã‚·ãƒ£ãƒ«|ã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ |ãƒãƒ¼ãƒ‰|ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼/)) { dice[name].suc++; }
          }
        }
      }
      const sM = rawText.match(/system\s*:\s*\[\s*(.*?)\s*\]\s*(.*?)\s*:\s*(\d+)\s*â†’\s*(\d+)/i);
      if (sM && checkedUsers.includes(sM[1].trim()) && parseInt(sM[4]) < parseInt(sM[3])) {
        const char = sM[1].trim(), attr = sM[2].trim(), diff = parseInt(sM[3]) - parseInt(sM[4]);
        if (!damage[char]) damage[char] = { name: char, hp: 0, san: 0 };
        if (attr.match(/HP|è€ä¹…/i)) damage[char].hp += diff;
        if (attr.match(/SAN|æ­£æ°—/i)) damage[char].san += diff;
      }
    });
    renderTables(Object.values(dice), Object.values(damage), chats, skills);
  }

  function renderTables(diceList, damageList, chats, skills) {
    const statsArea = document.getElementById('statsArea');
    statsArea.innerHTML = `
      <div class="stats-row"><div class="stats-card"><h3>âœ§ ãƒ€ã‚¤ã‚¹çµ±è¨ˆ</h3><div id="diceTableWrapper"></div></div></div>
      <div class="stats-row">
        <div class="stats-card"><h3>âœ§ HPæ¸›å°‘</h3><div id="hpTableWrapper"></div></div>
        <div class="stats-card"><h3>âœ§ SANæ¸›å°‘</h3><div id="sanTableWrapper"></div></div>
      </div>
      <div class="stats-row">
        <div class="stats-card"><h3>âœ§ ãƒãƒ£ãƒƒãƒˆå›æ•°</h3><div id="chatTableWrapper"></div></div>
        <div class="stats-card"><h3>âœ§ æŠ€èƒ½ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><div id="skillTableWrapper"></div></div>
      </div>`;

    diceList.sort((a, b) => b.total - a.total);
    let dH = '<table><thead><tr><th>åå‰</th><th style="text-align:right;">å›æ•°</th><th style="text-align:right;">æˆåŠŸç‡</th><th style="text-align:right;">C / F</th></tr></thead><tbody>';
    diceList.forEach(s => {
      dH += `<tr><td><span class="rank-name">${s.name}</span></td><td style="text-align:right; font-weight:700;">${s.total}</td><td style="text-align:right;">${((s.suc/s.total)*100).toFixed(0)}%</td><td style="text-align:right;"><span class="c-text">${s.crit}</span> / <span class="f-text">${s.fum}</span></td></tr>`;
    });
    document.getElementById('diceTableWrapper').innerHTML = diceList.length ? dH + '</tbody></table>' : '<p>ãªã—</p>';

    ['hp', 'san'].forEach(type => {
      const filtered = damageList.filter(d => d[type] > 0).sort((a, b) => b[type] - a[type]);
      const wrap = document.getElementById(type + 'TableWrapper');
      if (!filtered.length) { wrap.innerHTML = '<p>ãªã—</p>'; return; }
      const max = filtered[0][type], color = type === 'hp' ? 'var(--hp-red)' : 'var(--san-blue)';
      let h = '<table><thead><tr><th>åå‰</th><th style="text-align:right; width:60px;">æ¸›å°‘</th></tr></thead><tbody>';
      filtered.forEach(d => h += `<tr><td><span class="rank-name">${d.name}</span><div class="bar-container"><div class="bar-fill" style="width:${(d[type]/max*100)}%; background:${color}"></div></div></td><td style="text-align:right; vertical-align:top;"><span style="color:${color}; font-weight:800;">-${d[type]}</span></td></tr>`);
      wrap.innerHTML = h + '</tbody></table>';
    });

    const cL = Object.entries(chats).sort((a, b) => b[1] - a[1]);
    const maxC = cL.length > 0 ? cL[0][1] : 1;
    let cH = '<table><thead><tr><th>åå‰</th><th style="text-align:right; width:60px;">å›æ•°</th></tr></thead><tbody>';
    cL.forEach(([n, c]) => cH += `<tr><td><span class="rank-name">${n}</span><div class="bar-container"><div class="bar-fill" style="width:${(c/maxC*100)}%; background:var(--text-sub)"></div></div></td><td style="text-align:right; vertical-align:top;"><span style="font-weight:800;">${c}</span></td></tr>`);
    document.getElementById('chatTableWrapper').innerHTML = cL.length ? cH + '</tbody></table>' : '<p>ãªã—</p>';

    const sL = Object.entries(skills).sort((a, b) => b[1].total - a[1].total).slice(0, 15);
    let sH = '<table><thead><tr><th>æŠ€èƒ½</th><th>æœ€å¤šä½¿ç”¨è€…</th><th style="text-align:right;">å›æ•°</th></tr></thead><tbody>';
    sL.forEach(([n, data]) => {
      const topUser = Object.entries(data.users).sort((a, b) => b[1] - a[1])[0][0];
      sH += `<tr><td><span class="skill-tag">${n}</span></td><td style="color:var(--text-sub); font-size:0.9em;">${topUser}</td><td style="text-align:right; font-weight:700;">${data.total}</td></tr>`;
    });
    document.getElementById('skillTableWrapper').innerHTML = sL.length ? sH + '</tbody></table>' : '<p>ãªã—</p>';
  }

  document.getElementById('processBtn').addEventListener('click', function() {
    if (!originalHtml) return;
    extractDiceUsers(originalHtml);
    renderExcludeToggles();
    updateStats();
    document.getElementById('excludeSection').style.display = 'block';
    document.getElementById('statsArea').style.display = 'flex';
    document.getElementById('downloadBtn').style.display = 'inline-block';
    document.getElementById('saveRpHtmlBtn').style.display = 'inline-block';
    // è§£æãƒœã‚¿ãƒ³ã¯ä¸€åº¦æŠ¼ã—ãŸã‚‰æ¶ˆã™ï¼ˆã¾ãŸã¯çŠ¶æ…‹ç¶­æŒï¼‰
    this.style.display = 'none';
    document.getElementById('status').innerText = 'è§£æå®Œäº† ğŸ¦‘';
  });

  document.getElementById('saveRpHtmlBtn').addEventListener('click', () => {
    const doc = new DOMParser().parseFromString(originalHtml, 'text/html');
    doc.querySelectorAll('p').forEach(p => {
      const spans = p.querySelectorAll('span');
      if (spans.length > 0 && tabExcludeRegex.test(spans[0].innerText)) { p.remove(); return; }
      if (p.innerText.trim().startsWith('system :') || p.innerText.includes('å‰Šé™¤æ¸ˆ') || isPracticallyEmpty(spans[spans.length-1])) p.remove();
    });
    const b = new Blob([doc.documentElement.outerHTML], { type: 'text/html' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = currentFileName.replace(/\.[^/.]+$/, "") + "_Conversation.html"; a.click();
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const doc = new DOMParser().parseFromString(originalHtml, 'text/html');
    doc.querySelectorAll('p').forEach(p => {
      const spans = p.querySelectorAll('span');
      if (p.innerText.includes('å‰Šé™¤æ¸ˆ') || isPracticallyEmpty(spans[spans.length-1])) p.remove();
    });
    const b = new Blob([doc.documentElement.outerHTML], { type: 'text/html' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = currentFileName.replace(/\.[^/.]+$/, "") + "_cleaned.html"; a.click();
  });
</script>
</body>
</html>
